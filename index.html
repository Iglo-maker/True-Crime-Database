<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>True Crime Atlas</title>

  <!-- Three.js & Globe.gl -->
  <script src="https://unpkg.com/three@0.150.0/build/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl"></script>

  <style>
    :root {
      --bg: #000000;
      --accent: #ff3b3b;
      --text: #f5f5f5;
    }

    html, body {
      margin: 0;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: "Poppins", sans-serif;
      overflow: hidden;
    }

    #globeViz {
      position: absolute;
      inset: 0;
      width: 100vw;
      height: 100vh;
    }

    header {
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      pointer-events: none;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 2.2rem;
      color: var(--accent);
      pointer-events: auto;
      text-shadow: 0 0 10px rgba(255,59,59,0.4);
    }

    /* Heatmap Legend */
    #heatLegend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(20,20,20,0.75);
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #eee;
      border: 1px solid rgba(255,255,255,0.2);
      z-index: 10;
    }
    #heatLegend .legend-title {
      font-weight: bold;
      color: #ff5555;
      margin-bottom: 6px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 4px 0;
    }
    .legend-box {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      margin-right: 8px;
      display: inline-block;
    }
    .legend-box.none   { background: rgba(255,255,255,0.15); }
    .legend-box.low    { background: rgba(255,80,80,0.35); }
    .legend-box.medium { background: rgba(255,50,50,0.55); }
    .legend-box.high   { background: rgba(255,0,0,0.80); }

    /* Buttons */
    #topBtn, #rotBtn {
      position: absolute;
      right: 20px;
      background: #ff3b3b;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      z-index: 10;
      transition: .15s;
      box-shadow: 0 0 10px rgba(255,59,59,0.4);
    }

    #topBtn {
      top: 20px;
    }

    #rotBtn {
      top: 70px;
      background: #222;
      box-shadow: none;
      border: 1px solid #444;
    }

    #rotBtn:hover {
      border-color: #ff3b3b;
      color: #ff3b3b;
    }
    #topBtn:hover {
      background: #ff2020;
      transform: scale(1.05);
    }
  </style>
</head>
<body>

<header>
  <h1>True Crime Atlas</h1>
</header>

<div id="globeViz"></div>

<!-- Heatmap Legend -->
<div id="heatLegend">
  <div class="legend-title">Crime Heatmap</div>
  <div class="legend-item"><span class="legend-box none"></span> No cases</div>
  <div class="legend-item"><span class="legend-box low"></span> 1–3 cases</div>
  <div class="legend-item"><span class="legend-box medium"></span> 4–10 cases</div>
  <div class="legend-item"><span class="legend-box high"></span> 10+ cases</div>
</div>

<!-- Top Countries -->
<button id="topBtn">Highlight Top Countries</button>

<!-- Rotation Toggle -->
<button id="rotBtn">Stop Rotation</button>


<script>
/* === Globe Setup === */
const globe = Globe()(document.getElementById("globeViz"))
  .globeImageUrl("https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg")
  .bumpImageUrl("//unpkg.com/three-globe/example/img/earth-topology.png")
  .backgroundColor("#000000")
  .showAtmosphere(true)
  .atmosphereColor("#ff3b3b")
  .atmosphereAltitude(0.15)
  .polygonsTransitionDuration(200);

const controls = globe.controls();
controls.autoRotate = true;
controls.autoRotateSpeed = 0.7;

const renderer = globe.renderer();
renderer.toneMappingExposure = 1.3;

let countriesData = [];
let hoveredPolygon = null;

/* === LOCAL STORAGE CASE COUNTS === */
function getCaseCountForCountry(name) {
  const raw = localStorage.getItem("cases_" + name);
  if (!raw) return 0;

  try {
    const list = JSON.parse(raw);
    return Array.isArray(list) ? list.length : 0;
  } catch {
    return 0;
  }
}

/* === HEATMAP COLOR === */
function heatColor(countryName) {
  const c = getCaseCountForCountry(countryName);

  if (c === 0) return "rgba(255,255,255,0.15)";
  if (c <= 3) return "rgba(255,80,80,0.35)";
  if (c <= 10) return "rgba(255,50,50,0.55)";
  return "rgba(255,0,0,0.80)";
}

/* === 3D HEIGHT / EXTRUSION === */
function heightFactor(countryName) {
  const c = getCaseCountForCountry(countryName);
  if (c === 0) return 0.003;
  if (c <= 3) return 0.015;
  if (c <= 10) return 0.03;
  return 0.06;
}

/* === Load Country Shapes === */
fetch("https://raw.githubusercontent.com/vasturiano/globe.gl/master/example/datasets/ne_110m_admin_0_countries.geojson")
  .then(res => res.json())
  .then(data => {
    countriesData = data.features;

    globe
      .polygonsData(countriesData)
      .extrudePolygons(true)
      .polygonAltitude(d => heightFactor(d.properties.ADMIN))
      .polygonCapColor(d => heatColor(d.properties.ADMIN))
      .polygonSideColor(() => "rgba(255,255,255,0.25)")
      .polygonStrokeColor(() => "rgba(255,255,255,0.8)")
      .onPolygonHover(d => {
        hoveredPolygon = d;
        globe.polygonCapColor(f =>
          f === hoveredPolygon
            ? "rgba(255,59,59,0.6)"
            : heatColor(f.properties.ADMIN)
        );
      })
      .onPolygonClick(d => {
        const name = d.properties.ADMIN;
        window.location.href = `country.html?country=${encodeURIComponent(name)}`;
      });
  });

/* === HIGHLIGHT TOP COUNTRIES === */
function getTopCountries() {
  let scores = [];

  countriesData.forEach(c => {
    const name = c.properties.ADMIN;
    const count = getCaseCountForCountry(name);
    if (count > 0) scores.push({ name, count, obj: c });
  });

  return scores.sort((a, b) => b.count - a.count).slice(0, 5);
}

function zoomToTopCountries() {
  const top = getTopCountries();

  if (top.length === 0) {
    alert("No countries with cases.");
    return;
  }

  // highlight top
  globe.polygonCapColor(f => {
    const name = f.properties.ADMIN;
    if (top.find(t => t.name === name)) {
      return "rgba(255,0,0,0.95)";
    }
    return heatColor(name);
  });

  // zoom to top #1
  const first = top[0].obj;
  const center = first.properties.LABEL_X ? {
    lat: first.properties.LABEL_Y,
    lng: first.properties.LABEL_X
  } : { lat: 20, lng: 0 };

  globe.pointOfView({ lat: center.lat, lng: center.lng, altitude: 1.6 }, 1500);
}

document.getElementById("topBtn").addEventListener("click", zoomToTopCountries);

/* === ROTATION TOGGLE === */
let rotationEnabled = true;

document.getElementById("rotBtn").addEventListener("click", () => {
  rotationEnabled = !rotationEnabled;
  controls.autoRotate = rotationEnabled;
  document.getElementById("rotBtn").textContent =
    rotationEnabled ? "Stop Rotation" : "Start Rotation";
});
</script>

</body>
</html>
