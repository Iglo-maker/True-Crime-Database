<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>True Crime Atlas – Country</title>
  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: #0b0b0b;
      color: #f5f5f5;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      background: #111;
      border-bottom: 1px solid #ff3b3b;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: #ff3b3b;
    }

    header button {
      border: 1px solid rgba(255,255,255,0.3);
      background: transparent;
      color: #f5f5f5;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
    }

    main {
      padding: 14px 18px 40px;
      max-width: 900px;
      margin: 0 auto;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
      align-items: center;
    }

    .controls input,
    .controls select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: #181818;
      color: #f5f5f5;
      min-width: 120px;
    }

    .controls button {
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
      background: #202020;
      color: #f5f5f5;
      padding: 6px 10px;
      cursor: pointer;
    }

    .controls button:hover {
      background: #2b2b2b;
    }

    #caseForm {
      display: none;
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 10px;
      background: #151515;
      border: 1px solid rgba(255,255,255,0.2);
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    #caseForm input,
    #caseForm select,
    #caseForm textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.25);
      background: #202020;
      color: #f5f5f5;
      box-sizing: border-box;
    }

    #caseForm textarea {
      min-height: 120px;
      resize: vertical;
    }

    #caseForm .buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
    }

    #caseList .case-card {
      border-radius: 10px;
      background: #151515;
      border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 10px;
      overflow: hidden;
    }

    .case-header {
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: #1b1b1b;
    }

    .case-header:hover {
      background: #242424;
    }

    .case-title {
      font-weight: 600;
      color: #ff3b3b;
    }

    .case-meta {
      font-size: 0.8rem;
      color: #cccccc;
      margin-left: 8px;
    }

    .case-body {
      display: none;
      padding: 8px 10px 10px;
      font-size: 0.9rem;
    }

    .case-body img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 8px;
      display: block;
    }

    .no-cases {
      font-size: 0.9rem;
      color: #bbbbbb;
      font-style: italic;
      margin-top: 4px;
    }

    @media (max-width: 600px) {
      header h1 { font-size: 1.1rem; }
      .controls { flex-direction: column; align-items: stretch; }
      .controls input, .controls select, .controls button { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="countryTitle">Loading…</h1>
    <button onclick="window.location.href='index.html'">← Back to Globe</button>
  </header>

  <main>
    <section class="controls">
      <input type="text" id="searchInput" placeholder="Search by title or year" />
      <select id="typeFilter">
        <option value="all">All crime types</option>
        <option value="murder">Murder</option>
        <option value="theft">Theft</option>
        <option value="kidnapping">Kidnapping</option>
        <option value="heist">Heist</option>
        <option value="unsolved">Unsolved</option>
        <option value="other">Other</option>
      </select>
      <select id="yearFilter">
        <option value="all">All years</option>
      </select>
      <button id="addCaseBtn">+ Add Case</button>
      <button id="exportBtn">Export Cases</button>
    </section>

    <section id="caseForm">
      <input id="caseTitle" placeholder="Case title" />
      <input id="caseYear" type="number" placeholder="Year (e.g. 1995)" />
      <select id="caseType">
        <option value="murder">Murder</option>
        <option value="theft">Theft</option>
        <option value="kidnapping">Kidnapping</option>
        <option value="heist">Heist</option>
        <option value="unsolved">Unsolved</option>
        <option value="other">Other</option>
      </select>
      <input id="caseImage" placeholder="Image URL (optional)" />
      <textarea id="caseText" placeholder="Case description (factual & short)"></textarea>
      <div class="buttons">
        <button id="cancelCaseBtn" type="button">Cancel</button>
        <button id="saveCaseBtn" type="button">Save</button>
      </div>
    </section>

    <section id="caseList"></section>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const country = params.get('country') || 'Unknown country';

    const titleEl = document.getElementById('countryTitle');
    titleEl.textContent = country;

    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    const yearFilter = document.getElementById('yearFilter');
    const addCaseBtn = document.getElementById('addCaseBtn');
    const exportBtn = document.getElementById('exportBtn');
    const formSection = document.getElementById('caseForm');
    const saveCaseBtn = document.getElementById('saveCaseBtn');
    const cancelCaseBtn = document.getElementById('cancelCaseBtn');
    const caseListEl = document.getElementById('caseList');

    const caseTitleInput = document.getElementById('caseTitle');
    const caseYearInput = document.getElementById('caseYear');
    const caseTypeSelect = document.getElementById('caseType');
    const caseImageInput = document.getElementById('caseImage');
    const caseTextInput = document.getElementById('caseText');

    let cases = [];

    function loadCases() {
      try {
        cases = JSON.parse(localStorage.getItem('cases_' + country) || '[]');
      } catch {
        cases = [];
      }
    }

    function saveCases() {
      localStorage.setItem('cases_' + country, JSON.stringify(cases));
    }

    function updateYearFilterOptions() {
      const years = Array.from(new Set(cases.map(c => c.year).filter(Boolean))).sort();
      yearFilter.innerHTML = '<option value="all">All years</option>';
      years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearFilter.appendChild(opt);
      });
    }

    function renderCases() {
      const search = searchInput.value.trim().toLowerCase();
      const typeVal = typeFilter.value;
      const yearVal = yearFilter.value;

      caseListEl.innerHTML = '';

      let filtered = cases.slice();

      filtered = filtered.filter(c => {
        let ok = true;
        if (typeVal !== 'all' && c.type !== typeVal) ok = false;
        if (yearVal !== 'all' && String(c.year) !== yearVal) ok = false;
        if (search) {
          const hay = (c.title + ' ' + (c.year || '')).toLowerCase();
          if (!hay.includes(search)) ok = false;
        }
        return ok;
      });

      if (!filtered.length) {
        const p = document.createElement('p');
        p.className = 'no-cases';
        p.textContent = 'No cases yet. Add one with "+ Add Case".';
        caseListEl.appendChild(p);
        return;
      }

      filtered.forEach((c, index) => {
        const card = document.createElement('div');
        card.className = 'case-card';

        const header = document.createElement('div');
        header.className = 'case-header';

        const leftBox = document.createElement('div');
        const titleSpan = document.createElement('span');
        titleSpan.className = 'case-title';
        titleSpan.textContent = c.title || 'Untitled case';

        const metaSpan = document.createElement('span');
        metaSpan.className = 'case-meta';
        const yearText = c.year ? c.year : 'Year n/a';
        const typeText = c.type ? c.type : 'type n/a';
        metaSpan.textContent = `(${yearText} · ${typeText})`;

        leftBox.appendChild(titleSpan);
        leftBox.appendChild(metaSpan);

        header.appendChild(leftBox);

        const body = document.createElement('div');
        body.className = 'case-body';
        body.innerHTML = `<p>${(c.text || '').replace(/\n/g, '<br>')}</p>`;

        if (c.imageUrl) {
          const img = document.createElement('img');
          img.src = c.imageUrl;
          img.alt = c.title || 'Case image';
          body.appendChild(img);
        }

        header.addEventListener('click', () => {
          body.style.display = body.style.display === 'block' ? 'none' : 'block';
        });

        card.appendChild(header);
        card.appendChild(body);
        caseListEl.appendChild(card);
      });
    }

    function openForm() {
      formSection.style.display = 'flex';
    }

    function closeForm() {
      formSection.style.display = 'none';
      caseTitleInput.value = '';
      caseYearInput.value = '';
      caseTypeSelect.value = 'murder';
      caseImageInput.value = '';
      caseTextInput.value = '';
    }

    addCaseBtn.addEventListener('click', openForm);
    cancelCaseBtn.addEventListener('click', closeForm);

    saveCaseBtn.addEventListener('click', () => {
      const title = caseTitleInput.value.trim();
      const year = caseYearInput.value ? String(caseYearInput.value) : '';
      const type = caseTypeSelect.value;
      const img = caseImageInput.value.trim();
      const text = caseTextInput.value.trim();

      if (!title || !text) {
        alert('Please enter at least a title and description.');
        return;
      }

      const newCase = {
        title,
        year,
        type,
        imageUrl: img || '',
        text
      };

      cases.push(newCase);
      saveCases();
      updateYearFilterOptions();
      renderCases();
      closeForm();
    });

    // Filter events
    searchInput.addEventListener('input', renderCases);
    typeFilter.addEventListener('change', renderCases);
    yearFilter.addEventListener('change', renderCases);

    // Export cases as JSON file
    exportBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(cases, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `true-crime-${country.replace(/\s+/g, '_')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Init
    loadCases();
    updateYearFilterOptions();
    renderCases();
  </script>
</body>
</html>

