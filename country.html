<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>True Crime Atlas – Country</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --card: #181818;
      --accent: #ff3b3b;
      --accent-soft: rgba(255,59,59,0.25);
      --text: #f5f5f5;
      --muted: #9a9a9a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid #222;
      background: #101010;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .back-btn {
      border: 1px solid rgba(255,255,255,0.18);
      background: transparent;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .back-btn:hover {
      border-color: var(--accent);
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--accent);
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .primary-btn, .secondary-btn {
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      border: none;
    }

    .primary-btn {
      background: var(--accent);
      color: #fff;
    }

    .primary-btn:hover {
      box-shadow: 0 0 14px rgba(255,59,59,0.4);
    }

    .secondary-btn {
      background: #202020;
      color: var(--text);
      border: 1px solid #333;
    }

    .secondary-btn:hover {
      border-color: var(--accent-soft);
    }

    main {
      padding: 16px 20px 40px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .subtitle {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 14px;
    }

    /* Filterleiste */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
      background: #121212;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #1f1f1f;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 140px;
    }

    .filter-label {
      font-size: 0.78rem;
      color: var(--muted);
    }

    select, input {
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #1a1a1a;
      color: var(--text);
      padding: 6px 8px;
      font-size: 0.9rem;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Formular zum neuen Fall */
    #caseForm {
      margin-top: 16px;
      margin-bottom: 22px;
      display: none;
      background: #151515;
      border-radius: 10px;
      padding: 14px;
      border: 1px solid #2a2a2a;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .form-field {
      flex: 1 1 160px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    textarea {
      width: 100%;
      min-height: 110px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #1a1a1a;
      color: var(--text);
      padding: 8px;
      resize: vertical;
      font-size: 0.9rem;
    }

    /* Case Cards */
    #caseList {
      margin-top: 10px;
    }

    .case-card {
      background: var(--card);
      border-radius: 10px;
      border: 1px solid #222;
      margin-bottom: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: border-color 0.15s, box-shadow 0.15s, transform 0.08s;
    }

    .case-card:hover {
      border-color: var(--accent-soft);
      box-shadow: 0 0 12px rgba(0,0,0,0.6);
      transform: translateY(-1px);
    }

    .case-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .case-title {
      font-weight: 600;
      color: var(--accent);
    }

    .case-meta {
      font-size: 0.78rem;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .badge {
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(255,255,255,0.16);
      font-size: 0.7rem;
    }

    .badge-type {
      border-color: var(--accent-soft);
      color: var(--accent);
    }

    .case-body {
      display: none;
      margin-top: 8px;
      font-size: 0.9rem;
      line-height: 1.45;
      color: #e2e2e2;
    }

    .case-body img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 6px;
      display: block;
    }

    .empty-info {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 14px;
    }

    @media (max-width: 700px) {
      header { flex-wrap: wrap; gap: 8px; }
      .header-right { width: 100%; justify-content: flex-end; }
    }
  </style>
</head>
<body>
  <header>
    <button class="back-btn" onclick="window.location.href='index.html'">← Back to Globe</button>
    <h1 id="countryTitle">Country</h1>
    <div class="header-right">
      <button class="secondary-btn" id="exportBtn">Export Cases</button>
      <button class="primary-btn" id="toggleFormBtn">+ Add Case</button>
    </div>
  </header>

  <main>
    <div class="subtitle" id="subtitle"></div>

    <!-- Filter -->
    <div class="filter-bar">
      <div class="filter-group">
        <span class="filter-label">Crime Type</span>
        <select id="filterType">
          <option value="">All types</option>
          <option value="Murder">Murder</option>
          <option value="Theft">Theft</option>
          <option value="Kidnapping">Kidnapping</option>
          <option value="Robbery">Robbery</option>
          <option value="Fraud">Fraud</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Year</span>
        <input type="number" id="filterYear" placeholder="e.g. 1995" />
      </div>
      <div class="filter-group">
        <span class="filter-label">State / Region</span>
        <select id="filterRegion">
          <option value="">All regions</option>
          <!-- options are generated dynamically -->
        </select>
      </div>
    </div>

    <!-- Formular zum neuen Fall -->
    <section id="caseForm">
      <div class="form-row">
        <div class="form-field">
          <label for="caseTitle">Title</label>
          <input id="caseTitle" placeholder="Case title" />
        </div>
        <div class="form-field">
          <label for="caseYear">Year</label>
          <input id="caseYear" type="number" placeholder="e.g. 1988" />
        </div>
        <div class="form-field">
          <label for="caseType">Crime Type</label>
          <select id="caseType">
            <option value="">Select type…</option>
            <option value="Murder">Murder</option>
            <option value="Theft">Theft</option>
            <option value="Kidnapping">Kidnapping</option>
            <option value="Robbery">Robbery</option>
            <option value="Fraud">Fraud</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="caseRegion">State / Region</label>
          <input id="caseRegion" placeholder="e.g. Bavaria, Texas, Kansai" />
        </div>
        <div class="form-field">
          <label for="caseImage">Image URL (optional)</label>
          <input id="caseImage" placeholder="https://example.com/image.jpg" />
        </div>
      </div>

      <div class="form-field">
        <label for="caseText">Description (keep it factual and respectful)</label>
        <textarea id="caseText" placeholder="Write the case here…"></textarea>
      </div>

      <button class="primary-btn" id="saveCaseBtn" style="margin-top:10px;">Save Case</button>
    </section>

    <!-- Liste der Fälle -->
    <section id="caseList"></section>
  </main>

  <script>
    // --- Basics: Land aus URL lesen ---
    const params = new URLSearchParams(window.location.search);
    const country = params.get("country") || "Unknown Country";

    const titleEl = document.getElementById("countryTitle");
    const subtitleEl = document.getElementById("subtitle");
    titleEl.textContent = country;
    subtitleEl.textContent = "Cases stored locally for " + country + ". (Data is saved only in this browser)";

    // --- DOM-Elemente ---
    const caseListEl   = document.getElementById("caseList");
    const formSection  = document.getElementById("caseForm");
    const toggleFormBtn = document.getElementById("toggleFormBtn");
    const saveCaseBtn  = document.getElementById("saveCaseBtn");
    const exportBtn    = document.getElementById("exportBtn");

    // Formular-Felder
    const caseTitleEl  = document.getElementById("caseTitle");
    const caseYearEl   = document.getElementById("caseYear");
    const caseTypeEl   = document.getElementById("caseType");
    const caseRegionEl = document.getElementById("caseRegion");
    const caseImageEl  = document.getElementById("caseImage");
    const caseTextEl   = document.getElementById("caseText");

    // Filter-Felder
    const filterTypeEl   = document.getElementById("filterType");
    const filterYearEl   = document.getElementById("filterYear");
    const filterRegionEl = document.getElementById("filterRegion");

    // --- Daten aus localStorage laden ---
    let cases = [];
    function loadCases() {
      try {
        const raw = localStorage.getItem("cases_" + country);
        cases = raw ? JSON.parse(raw) : [];
      } catch(e) {
        cases = [];
      }
    }

    function saveCases() {
      localStorage.setItem("cases_" + country, JSON.stringify(cases));
    }

    // --- Regionen-Liste (State/Region-Dropdown) aktualisieren ---
    function updateRegionFilterOptions() {
      const regions = new Set();
      cases.forEach(c => {
        if(c.region && c.region.trim()) regions.add(c.region.trim());
      });

      // Alte Optionen löschen
      filterRegionEl.innerHTML = "";
      const defaultOpt = document.createElement("option");
      defaultOpt.value = "";
      defaultOpt.textContent = "All regions";
      filterRegionEl.appendChild(defaultOpt);

      Array.from(regions).sort().forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        filterRegionEl.appendChild(opt);
      });
    }

    // --- Cases rendern mit Filtern ---
    function renderCases() {
      caseListEl.innerHTML = "";

      if(!cases.length) {
        caseListEl.innerHTML = '<p class="empty-info">No cases yet. Add your first case above.</p>';
        return;
      }

      const typeFilter   = filterTypeEl.value;
      const yearFilter   = filterYearEl.value;
      const regionFilter = filterRegionEl.value;

      const filtered = cases.filter(c => {
        if(typeFilter && c.type !== typeFilter) return false;
        if(yearFilter && String(c.year) !== String(yearFilter)) return false;
        if(regionFilter && c.region !== regionFilter) return false;
        return true;
      });

      if(!filtered.length) {
        caseListEl.innerHTML = '<p class="empty-info">No cases match the current filters.</p>';
        return;
      }

      filtered.forEach((c, index) => {
        const card = document.createElement("article");
        card.className = "case-card";

        const header = document.createElement("div");
        header.className = "case-header";

        const title = document.createElement("div");
        title.className = "case-title";
        title.textContent = c.title || "(Untitled case)";

        const meta = document.createElement("div");
        meta.className = "case-meta";

        const yearSpan = document.createElement("span");
        yearSpan.textContent = c.year ? `Year: ${c.year}` : "Year: unknown";

        const typeSpan = document.createElement("span");
        typeSpan.className = "badge badge-type";
        typeSpan.textContent = c.type || "Type: n/a";

        const regionSpan = document.createElement("span");
        regionSpan.className = "badge";
        regionSpan.textContent = c.region ? `Region: ${c.region}` : "Region: n/a";

        meta.appendChild(yearSpan);
        meta.appendChild(typeSpan);
        meta.appendChild(regionSpan);

        header.appendChild(title);
        header.appendChild(meta);

        const body = document.createElement("div");
        body.className = "case-body";

        const textP = document.createElement("p");
        textP.textContent = c.text || "(no description)";
        body.appendChild(textP);

        if(c.imageUrl) {
          const img = document.createElement("img");
          img.src = c.imageUrl;
          img.alt = "Case image";
          body.appendChild(img);
        }

        card.appendChild(header);
        card.appendChild(body);

        // Klick: Body auf/zu
        card.addEventListener("click", () => {
          const isVisible = body.style.display === "block";
          body.style.display = isVisible ? "none" : "block";
        });

        caseListEl.appendChild(card);
      });
    }

    // --- Formular anzeigen/verstecken ---
    toggleFormBtn.addEventListener("click", () => {
      const visible = formSection.style.display === "block";
      formSection.style.display = visible ? "none" : "block";
    });

    // --- Neuen Fall speichern ---
    saveCaseBtn.addEventListener("click", () => {
      const title = caseTitleEl.value.trim();
      const year  = caseYearEl.value.trim();
      const type  = caseTypeEl.value;
      const region = caseRegionEl.value.trim();
      const image = caseImageEl.value.trim();
      const text  = caseTextEl.value.trim();

      if(!title || !year || !type || !region || !text) {
        alert("Please fill in Title, Year, Type, Region and Description.");
        return;
      }

      const yearNum = parseInt(year, 10);

      const newCase = {
        title,
        year: isNaN(yearNum) ? year : yearNum,
        type,
        region,
        imageUrl: image || "",
        text,
        createdAt: new Date().toISOString()
      };

      cases.push(newCase);
      saveCases();
      updateRegionFilterOptions();
      renderCases();

      // Formular leeren
      caseTitleEl.value = "";
      caseYearEl.value = "";
      caseTypeEl.value = "";
      caseRegionEl.value = "";
      caseImageEl.value = "";
      caseTextEl.value = "";

      formSection.style.display = "none";
    });

    // --- Filter-Events ---
    filterTypeEl.addEventListener("change", renderCases);
    filterYearEl.addEventListener("input", renderCases);
    filterRegionEl.addEventListener("change", renderCases);

    // --- Export-Funktion ---
    exportBtn.addEventListener("click", () => {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cases, null, 2));
      const a = document.createElement("a");
      a.setAttribute("href", dataStr);
      a.setAttribute("download", `true-crime-${country.replace(/\s+/g,'_')}.json`);
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // Initial laden
    loadCases();
    updateRegionFilterOptions();
    renderCases();
  </script>
</body>
</html>
