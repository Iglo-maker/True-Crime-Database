<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>True Crime Atlas – Country</title>
  <style>
    :root{
      --bg: #0b0b0b;
      --card: #181818;
      --border: #ff3b3b;
      --accent: #ff3b3b;
      --text: #f5f5f5;
      --muted: #9a9a9a;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Poppins",sans-serif;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 20px;
      border-bottom:1px solid rgba(255,59,59,0.5);
      background:#101010;
      position:sticky;
      top:0;
      z-index:10;
    }
    #countryTitle{
      margin:0;
      font-size:1.4rem;
      color:var(--accent);
    }
    header button{
      background:var(--accent);
      border:none;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-size:0.9rem;
    }
    header button:hover{
      box-shadow:0 4px 14px rgba(255,59,59,0.4);
    }

    .top-bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding:12px 20px;
      background:#121212;
      border-bottom:1px solid #222;
    }
    .top-bar select,
    .top-bar input{
      background:#181818;
      border:1px solid #333;
      border-radius:8px;
      padding:6px 8px;
      color:var(--text);
      font-size:0.85rem;
      min-width:120px;
    }
    .top-bar input::placeholder{
      color:#666;
    }

    .actions{
      margin-left:auto;
      display:flex;
      gap:8px;
    }
    .actions button{
      background:#181818;
      color:var(--text);
      border:1px solid #333;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer;
      font-size:0.85rem;
    }
    .actions button:hover{
      border-color:var(--accent);
      color:var(--accent);
    }

    #caseForm{
      display:none;
      padding:14px 20px;
      background:#101010;
      border-bottom:1px solid #222;
      display:none;
    }
    #caseForm form{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px,1fr));
      gap:10px;
    }
    #caseForm textarea{
      grid-column:1/-1;
      min-height:120px;
    }
    #caseForm input,
    #caseForm select,
    #caseForm textarea{
      background:#181818;
      border:1px solid #333;
      border-radius:8px;
      padding:8px;
      color:var(--text);
      font-size:0.85rem;
    }
    #caseForm button.save{
      margin-top:8px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:8px;
      padding:8px 14px;
      cursor:pointer;
      font-size:0.9rem;
    }

    #caseList{
      padding:18px 20px 40px;
      max-width:900px;
      margin:0 auto;
    }

    .case-card{
      background:var(--card);
      border-radius:10px;
      border:1px solid #262626;
      margin-bottom:10px;
      overflow:hidden;
    }
    .case-header{
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }
    .case-title{
      font-weight:600;
      color:var(--accent);
      font-size:0.95rem;
    }
    .case-meta{
      font-size:0.75rem;
      color:var(--muted);
      margin-top:4px;
    }
    .case-toggle{
      font-size:0.8rem;
      color:var(--muted);
    }
    .case-body{
      display:none;
      padding:0 12px 12px;
      font-size:0.85rem;
      line-height:1.4;
      border-top:1px solid #222;
      white-space:pre-wrap;
    }
    .case-body img{
      max-width:100%;
      border-radius:6px;
      margin-top:6px;
    }

    .empty{
      text-align:center;
      color:#777;
      margin-top:20px;
      font-size:0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="countryTitle">Loading…</h1>
    <button onclick="window.location.href='index.html'">← Back to Globe</button>
  </header>

  <!-- Filterleiste -->
  <div class="top-bar">
    <select id="filterType">
      <option value="">All crime types</option>
      <option value="Murder">Murder</option>
      <option value="Kidnapping">Kidnapping</option>
      <option value="Robbery">Robbery</option>
      <option value="Theft">Theft</option>
      <option value="Fraud">Fraud</option>
      <option value="Missing">Missing person</option>
      <option value="Unsolved">Unsolved</option>
      <option value="Other">Other</option>
    </select>

  
    </select>

    <input id="filterYear" type="number" placeholder="Year (e.g. 1999)" />

    <div class="actions">
      <input id="searchInput" type="text" placeholder="Search title / text / year" />
      <button id="clearFiltersBtn">Clear</button>
      <button id="exportBtn">Export</button>
      <button id="addCaseBtn">+ Add Case</button>
    </div>
  </div>

  <!-- Neues Fall-Formular -->
  <div id="caseForm">
    <form id="caseFormInner" onsubmit="return false;">
      <input id="caseTitle" placeholder="Case title" required />

      <select id="caseType" required>
        <option value="">Crime type…</option>
        <option value="Murder">Murder</option>
        <option value="Kidnapping">Kidnapping</option>
        <option value="Robbery">Robbery</option>
        <option value="Theft">Theft</option>
        <option value="Fraud">Fraud</option>
        <option value="Missing">Missing person</option>
        <option value="Unsolved">Unsolved</option>
        <option value="Other">Other</option>
      </select>

      <select id="caseRegion">
        <!-- wird per JS mit gleichen Regionen wie FilterRegion befüllt -->
      </select>

      <input id="caseYear" type="number" placeholder="Year (e.g. 1999)" />

      <input id="caseImageUrl" type="url" placeholder="Image URL (optional)" />

      <textarea id="caseText" placeholder="Case description (short, factual)" required></textarea>
    </form>
    <button class="save" id="saveCaseBtn">Save Case</button>
  </div>

  <div id="caseList"></div>

  <script>
    // ---------- Country Name aus URL ----------
    const params = new URLSearchParams(window.location.search);
    const country = params.get('country') || 'Unknown Country';
    const countryTitle = document.getElementById('countryTitle');
    countryTitle.textContent = country;

    

    // ---------- Cases aus localStorage ----------
    const STORAGE_KEY = "cases_" + country;
    let cases = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

    const caseListEl = document.getElementById('caseList');
    const filterType = document.getElementById('filterType');
    const filterYear = document.getElementById('filterYear');
    const searchInput = document.getElementById('searchInput');

    function saveCases(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cases));
    }

    function matchesFilters(c){
      const typeVal = filterType.value;
      const yearVal = filterYear.value.trim();
      const q = searchInput.value.trim().toLowerCase();

      if(typeVal && c.type !== typeVal) return false;
      if(yearVal && String(c.year || "").toString() !== yearVal) return false;

      if(q){
        const inTitle = (c.title || "").toLowerCase().includes(q);
        const inText = (c.text || "").toLowerCase().includes(q);
        const inYear = String(c.year || "").includes(q);
        if(!inTitle && !inText && !inYear) return false;
      }
      return true;
    }

    function renderCases(){
      caseListEl.innerHTML = "";

      if(!cases.length){
        caseListEl.innerHTML = '<div class="empty">No cases yet. Add one with “+ Add Case”.</div>';
        return;
      }

      const filtered = cases.filter(matchesFilters);

      if(!filtered.length){
        caseListEl.innerHTML = '<div class="empty">No cases match your filters/search.</div>';
        return;
      }

      filtered.forEach((c, index) => {
        const card = document.createElement('div');
        card.className = 'case-card';

        const header = document.createElement('div');
        header.className = 'case-header';

        const left = document.createElement('div');
        const titleEl = document.createElement('div');
        titleEl.className = 'case-title';
        titleEl.textContent = c.title || '(Untitled case)';

        const metaEl = document.createElement('div');
        metaEl.className = 'case-meta';
        const parts = [];
        if(c.year) parts.push(c.year);
        if(c.type) parts.push(c.type);
        if(c.region) parts.push(c.region);
        metaEl.textContent = parts.join(' • ');

        left.appendChild(titleEl);
        left.appendChild(metaEl);

        const toggleEl = document.createElement('div');
        toggleEl.className = 'case-toggle';
        toggleEl.textContent = 'Show';

        header.appendChild(left);
        header.appendChild(toggleEl);

        const body = document.createElement('div');
        body.className = 'case-body';
        body.textContent = c.text || "";

        if(c.imageUrl){
          const img = document.createElement('img');
          img.src = c.imageUrl;
          img.alt = c.title || "Case image";
          body.appendChild(document.createElement('br'));
          body.appendChild(img);
        }

        header.addEventListener('click', () => {
          const visible = body.style.display === 'block';
          body.style.display = visible ? 'none' : 'block';
          toggleEl.textContent = visible ? 'Show' : 'Hide';
        });

        card.appendChild(header);
        card.appendChild(body);
        caseListEl.appendChild(card);
      });
    }

    renderCases();

    // ---------- Add Case ----------
    const addCaseBtn = document.getElementById('addCaseBtn');
    const caseForm = document.getElementById('caseForm');
    const saveCaseBtn = document.getElementById('saveCaseBtn');

    addCaseBtn.addEventListener('click', () => {
      const isVisible = caseForm.style.display === 'block';
      caseForm.style.display = isVisible ? 'none' : 'block';
    });

    saveCaseBtn.addEventListener('click', () => {
      const title = document.getElementById('caseTitle').value.trim();
      const text = document.getElementById('caseText').value.trim();
      const type = document.getElementById('caseType').value;
      const region = document.getElementById('caseRegion').value;
      const year = document.getElementById('caseYear').value.trim();
      const imageUrl = document.getElementById('caseImageUrl').value.trim();

      if(!title || !text || !type){
        alert("Please fill in title, description and crime type.");
        return;
      }

      const newCase = {
        title,
        text,
        type,
        region,
        year: year ? parseInt(year) : null,
        imageUrl: imageUrl || null,
        createdAt: Date.now()
      };

      cases.push(newCase);
      saveCases();

      // Formular leeren
      document.getElementById('caseTitle').value = "";
      document.getElementById('caseText').value = "";
      document.getElementById('caseType').value = "";
      document.getElementById('caseRegion').value = regionOptions[0] || "";
      document.getElementById('caseYear').value = "";
      document.getElementById('caseImageUrl').value = "";

      caseForm.style.display = 'none';
      renderCases();
    });

    // ---------- Filter-Events ----------
    filterType.addEventListener('change', renderCases);
    filterRegionSelect.addEventListener('change', renderCases);
    filterYear.addEventListener('input', renderCases);
    searchInput.addEventListener('input', renderCases);

    document.getElementById('clearFiltersBtn').addEventListener('click', () => {
      filterType.value = "";
      filterRegionSelect.value = "";
      filterYear.value = "";
      searchInput.value = "";
      renderCases();
    });

    // ---------- Export ----------
    document.getElementById('exportBtn').addEventListener('click', () => {
      if(!cases.length){
        alert("No cases to export.");
        return;
      }
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cases, null, 2));
      const a = document.createElement('a');
      a.setAttribute("href", dataStr);
      a.setAttribute("download", country.replace(/\s+/g,'_') + "_cases.json");
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  </script>
</body>
</html>
